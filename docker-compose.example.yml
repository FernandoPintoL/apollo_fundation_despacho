version: '3.8'

services:
  # Apollo Gateway - Startup Resiliente
  # Nota: NO necesita depend_on ni condition service_healthy
  # Se levanta independientemente y descubre servicios conforme están listos
  apollo-gateway:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: apollo-gateway
    ports:
      - "4000:4000"
    environment:
      NODE_ENV: development
      DEBUG: "false"
      PORT: 4000

      # Habilitar servicios (adjust based on what you have running)
      ENABLED_SERVICES: despacho,autentificacion

      # URLs de los microservicios (use service names for Docker network)
      MS_DESPACHO_URL: http://ms-despacho:8001/graphql
      MS_AUTENTIFICACION_URL: http://ms-autentificacion:8000/graphql
      MS_RECEPCION_URL: http://ms-recepcion:8080/api/graphql
      MS_WEBSOCKET_URL: http://ms-websocket:4004/graphql
      MS_DECISION_URL: http://ms-decision:8002/graphql
      MS_ML_DESPACHO_URL: http://ms-ml-despacho:5001/graphql

      # Configuración de seguridad (CHANGE THESE IN PRODUCTION!)
      API_KEY_ADMIN: admin-key-change-in-production-12345
      JWT_SECRET: jwt-secret-change-in-production

    # NO necesita depend_on porque es resiliente
    # Puede arrancar sin que los servicios estén listos

    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:4000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s  # Espera 90s antes de validar health

    restart: unless-stopped
    networks:
      - swii-network

  # Microservicio: Despacho (ms-despacho)
  ms-despacho:
    build:
      context: ../ms-despacho
      dockerfile: Dockerfile
    container_name: ms-despacho
    ports:
      - "8001:8001"
    environment:
      NODE_ENV: development
      PORT: 8001
      # Add your despacho-specific env vars here
    restart: unless-stopped
    networks:
      - swii-network
    # Note: No depends_on en apollo-gateway - es tolerante a fallos

  # Microservicio: Autentificación (ms_autentificacion)
  ms-autentificacion:
    build:
      context: ../ms_autentificacion
      dockerfile: Dockerfile
    container_name: ms-autentificacion
    ports:
      - "8000:8000"
    environment:
      NODE_ENV: development
      PORT: 8000
      # Add your autentificacion-specific env vars here
    restart: unless-stopped
    networks:
      - swii-network
    # Note: No depends_on en apollo-gateway - es tolerante a fallos

  # Microservicio: Recepción
  ms-recepcion:
    build:
      context: ../ms_recepcion
      dockerfile: Dockerfile
    container_name: ms-recepcion
    ports:
      - "8080:8080"
    environment:
      NODE_ENV: development
      PORT: 8080
      # Add your recepcion-specific env vars here
    restart: unless-stopped
    networks:
      - swii-network
    # Note: No depends_on en apollo-gateway - es tolerante a fallos

  # Microservicio: WebSocket
  ms-websocket:
    build:
      context: ../ms_websocket
      dockerfile: Dockerfile
    container_name: ms-websocket
    ports:
      - "4004:4004"
    environment:
      NODE_ENV: development
      PORT: 4004
      # Add your websocket-specific env vars here
    restart: unless-stopped
    networks:
      - swii-network
    # Note: No depends_on en apollo-gateway - es tolerante a fallos

  # Microservicio: Decision
  ms-decision:
    build:
      context: ../ms_decision
      dockerfile: Dockerfile
    container_name: ms-decision
    ports:
      - "8002:8002"
    environment:
      NODE_ENV: development
      PORT: 8002
      # Add your decision-specific env vars here
    restart: unless-stopped
    networks:
      - swii-network
    # Note: No depends_on en apollo-gateway - es tolerante a fallos

  # Microservicio: ML Despacho
  ms-ml-despacho:
    build:
      context: ../ms_ml_despacho
      dockerfile: Dockerfile
    container_name: ms-ml-despacho
    ports:
      - "5001:5001"
    environment:
      NODE_ENV: development
      PORT: 5001
      # Add your ml_despacho-specific env vars here
    restart: unless-stopped
    networks:
      - swii-network
    # Note: No depends_on en apollo-gateway - es tolerante a fallos

networks:
  swii-network:
    driver: bridge
