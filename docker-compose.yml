services:
  # ============================================
  # Redis - Message Broker para eventos
  # ============================================
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    environment:
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
      - swii-network
    volumes:
      - redis-data:/data

  # ============================================
  # Apollo Gateway - SOLO GATEWAY
  # Los microservicios corren localmente en tu máquina
  # Las BDs usan tu PostgreSQL local en 5432 y 5433
  # ============================================
  apollo-gateway:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "4000:4000"
    environment:
      NODE_ENV: development
      DEBUG: "false"
      PORT: 4000
      RUNNING_IN_DOCKER: "true"

      # Habilitar servicios - ajusta según cuáles corren localmente
      ENABLED_SERVICES: despacho,autentificacion

      # URLs de los microservicios (se calculan automáticamente con host.docker.internal)
      # MS_DESPACHO_URL: http://host.docker.internal:8001/graphql
      # MS_AUTENTIFICACION_URL: http://host.docker.internal:8000/graphql

      # Configuración de seguridad
      API_KEY_ADMIN: admin-key-change-in-production
      JWT_SECRET: jwt-secret-change-in-production

      # Redis Configuration (para eventos)
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}

    # Sin depends_on porque los servicios no están en Docker
    # Apollo Gateway verificará disponibilidad al iniciar

    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:4000/health', (r) => {if (r.statusCode !== 200) throw new Error(r.statusCode)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s

    restart: unless-stopped

networks:
  swii-network:
    driver: bridge

volumes:
  redis-data:
